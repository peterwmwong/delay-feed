<!DOCTYPE html>
<html>
<title>delay feed</title>
<style>
    html,
    body {
        position: relative;
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
        background: black;
    }

    #delayedFeed,
    #liveFeedVideo {
        position: absolute;
    }

    #liveFeedVideo {
        width: 100%;
        height: 100%;
    }

    #delayedFeed {
        bottom: 24px;
        right: 24px;
        box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
        background-color: rgba(0, 0, 0, 0.5);
    }

    #delayedFeedCaption {
        color: white;
        font-family: sans-serif;
        font-size: 2.5rem;
        width: 100%;
        position: relative;
        background-color: rgba(255.0, 0, 0, 0.75);
        text-align: center;
    }
</style>

<body>
    <video id="liveFeedVideo" autoplay></video>
    <div id="delayedFeed">
        <div id="delayedFeedCaption">Delayed Feed</div>
        <video id="delayedFeedVideo" autoplay controls></video>
    </div>
    <script type="module">
        try {
            const DELAY_S = 2;
            const DELAY_MS = DELAY_S * 1000;
            const { liveFeedVideo, delayedFeedVideo } = window;
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            liveFeedVideo.srcObject = stream;
            const { width, height } = stream.getTracks()[0].getSettings();
            const [delayedWidth, delayedHeight] = [width * .75, height * .75];
            delayedFeedVideo.width = delayedWidth;
            delayedFeedVideo.height = delayedHeight;
            const mediaSource = new MediaSource();
            delayedFeedVideo.src = URL.createObjectURL(mediaSource);
            mediaSource.addEventListener('sourceopen', () => {
                URL.revokeObjectURL(delayedFeedVideo.src);
                const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs="vp9"' });
                const srcBuf = mediaSource.addSourceBuffer(recorder.mimeType);
                srcBuf.addEventListener('update', () => {
                    const { buffered } = srcBuf;
                    if (buffered.length && buffered.end(0) - buffered.start(0) > DELAY_S * 6) {
                        srcBuf.remove(buffered.start(0), buffered.start(0) + DELAY_S);
                    }
                });
                recorder.addEventListener('dataavailable', async ({ data }) => {
                    const bytes = await data.arrayBuffer();
                    const update = () => srcBuf.appendBuffer(bytes);
                    if (srcBuf.updating) {
                        srcBuf.addEventListener('update', update(), { once: true })
                    } else {
                        update();
                    }
                })
                recorder.start(DELAY_MS);
            }, { once: true });
        } catch (e) { alert(e) };
    </script>
</body>

</html>