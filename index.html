<!DOCTYPE html>
<html>

<head>
    <title>delay feed</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        html,
        body {
            position: relative;
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
            background: black;
            font-family: sans-serif;
            font-size: 14px;
        }

        #delayedFeed,
        #liveFeedVideo {
            position: absolute;
        }

        #liveFeedVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #delayedFeed {
            bottom: 24px;
            right: 24px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
            background-color: rgba(0, 0, 0, 0.5);
            width: 33%;
            aspect-ratio: 1 / 1;
            overflow: hidden;
        }

        #delayedFeedCaption {
            color: white;
            position: relative;
            background-color: rgba(255, 0, 0, 0.5);
            text-align: center;
            position: absolute;
            width: 100%;
            bottom: 0;
            opacity: 0.75;
        }

        .mirror {
            transform: scaleX(-1);
        }
    </style>
</head>

<body onclick="document.body.requestFullscreen({ navigationUI: 'hide' });">
    <video id="liveFeedVideo" class="mirror" autoplay></video>
    <div id="delayedFeed">
        <div class="mirror">
            <canvas id="delayedFeedCanvas"></canvas>
        </div>
        <div id="delayedFeedCaption">Delayed Feed</div>
    </div>
    <script type="module">
        try {
            const DELAY_S = 2;
            const DELAY_MS = DELAY_S * 1000;
            const { liveFeedVideo, delayedFeedCanvas, delayedFeed } = window;
            const captureCanvas = document.createElement('canvas');
            const captureCtx = captureCanvas.getContext('2d');
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: Math.max(screen.width, screen.height) * 2 },
                    height: { ideal: Math.min(screen.width, screen.height) * 2 },
                    frameRate: { ideal: 30 },
                    aspectRatio: { ideal: 1.777777777 }
                }
            });
            liveFeedVideo.srcObject = stream;
            const { width, height, aspectRatio } = stream.getTracks()[0].getSettings();
            delayedFeed.style.aspectRatio = `${aspectRatio}`
            const [delayedWidth, delayedHeight] = [width, height];
            captureCanvas.width = delayedFeedCanvas.width = delayedWidth;
            captureCanvas.height = delayedFeedCanvas.height = delayedHeight;

            const resizeDelayedFeedVideo = () => {
                const tx = delayedFeed.clientWidth / delayedWidth;
                delayedFeedCanvas.style.transform = `scale3d(${tx}, ${tx}, 1)`;
                delayedFeedCanvas.style.transformOrigin = 'top left';
            }
            window.onresize = resizeDelayedFeedVideo;
            resizeDelayedFeedVideo();

            const renderVideoToCanvasLoop = () => {
                window.requestAnimationFrame(() => {
                    captureCtx.drawImage(liveFeedVideo, 0, 0, delayedWidth, delayedHeight);
                    const frame = captureCtx.getImageData(0, 0, delayedWidth, delayedHeight);
                    setTimeout(() => delayedFeedCanvas.getContext('2d').putImageData(frame, 0, 0), DELAY_MS);
                    renderVideoToCanvasLoop();
                });
            }
            renderVideoToCanvasLoop();
        } catch (e) { alert(e) };
    </script>
</body>

</html>